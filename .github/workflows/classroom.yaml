name: Hidden Tests

on:
  push:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1️⃣ Checkout student repository
      - uses: actions/checkout@v4

      # 2️⃣ Setup Java
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ Install jq (required for GitHub API parsing)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 4️⃣ Verify secret exists
      - name: Verify token
        run: |
          if [ -z "${{ secrets.TEST_REPO_TOKEN }}" ]; then
            echo "ERROR: TEST_REPO_TOKEN secret is not set!"
            exit 1
          fi
          echo "Token is present"

      # 5️⃣ Download hidden-tests.jar from private repo release
      - name: Download test JAR
        run: |
          TOKEN="${{ secrets.TEST_REPO_TOKEN }}"

          RELEASE_JSON=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/SITE-ADA/wm2_spring_26_lab5_tests/releases/latest)

          ASSET_ID=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name=="hidden-tests.jar") | .id')

          if [ -z "$ASSET_ID" ] || [ "$ASSET_ID" = "null" ]; then
            echo "ERROR: hidden-tests.jar not found in latest release"
            echo "$RELEASE_JSON"
            exit 1
          fi

          echo "Downloading hidden-tests.jar (asset id: $ASSET_ID)"

          curl -L \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/octet-stream" \
            https://api.github.com/repos/SITE-ADA/wm2_spring_26_lab5_tests/releases/assets/$ASSET_ID \
            -o hidden-tests.jar \
            --fail

          echo "Download successful"
          ls -la hidden-tests.jar

      # 6️⃣ Download JUnit Console Standalone
      - name: Download JUnit Console
        run: |
          curl -L -o junit-platform-console-standalone.jar \
          https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.10.0/junit-platform-console-standalone-1.10.0.jar

      # 7️⃣ Compile student source only (NOT tests)
      - name: Compile student code
        run: |
          chmod +x ./gradlew
          ./gradlew clean compileJava

      # 8️⃣ Run hidden tests
      - name: Run hidden tests
        run: |
          java -jar junit-platform-console-standalone.jar \
            --class-path hidden-tests.jar:build/classes/java/main \
            --scan-class-path \
            --details=tree \
            --reports-dir=build/test-results/test \
            --fail-if-no-tests

      # 9️⃣ Upload test results
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/
          if-no-files-found: warn